/*! For license information please see 916ea1ed.df4ab124.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[618205],{148119:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>r,default:()=>u,frontMatter:()=>i,metadata:()=>o,toc:()=>d});var s=n(785893),a=n(511151);const i={id:"testing",title:"Testing Backend Plugins and Modules",sidebar_label:"Testing",description:"Learn how to test your backend plugins and modules"},r=void 0,o={id:"backend-system/building-plugins-and-modules/testing",title:"Testing Backend Plugins and Modules",description:"Learn how to test your backend plugins and modules",source:"@site/versioned_docs/version-stable/backend-system/building-plugins-and-modules/02-testing.md",sourceDirName:"backend-system/building-plugins-and-modules",slug:"/backend-system/building-plugins-and-modules/testing",permalink:"/docs/backend-system/building-plugins-and-modules/testing",draft:!1,unlisted:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/versioned_docs/version-stable/backend-system/building-plugins-and-modules/02-testing.md",tags:[],version:"stable",sidebarPosition:2,frontMatter:{id:"testing",title:"Testing Backend Plugins and Modules",sidebar_label:"Testing",description:"Learn how to test your backend plugins and modules"},sidebar:"docs",previous:{title:"Overview",permalink:"/docs/backend-system/building-plugins-and-modules/index"},next:{title:"Migration Guide",permalink:"/docs/backend-system/building-plugins-and-modules/migrating"}},c={},d=[{value:"Testing Backend Plugins and Modules",id:"testing-backend-plugins-and-modules",level:2},{value:"Testing Remote Service Interactions",id:"testing-remote-service-interactions",level:2},{value:"Testing Database Interactions",id:"testing-database-interactions",level:2},{value:"Testing Service Factories",id:"testing-service-factories",level:2}];function l(e){const t={a:"a",code:"code",em:"em",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(t.p,{children:["Utilities for testing backend plugins and modules are available in\n",(0,s.jsx)(t.code,{children:"@backstage/backend-test-utils"}),". This section describes those facilities."]}),"\n",(0,s.jsx)(t.h2,{id:"testing-backend-plugins-and-modules",children:"Testing Backend Plugins and Modules"}),"\n",(0,s.jsxs)(t.p,{children:["To facilitate testing of backend plugins and modules, the\n",(0,s.jsx)(t.code,{children:"@backstage/backend-test-utils"})," package provides a ",(0,s.jsx)(t.code,{children:"startTestBackend"})," function\nwhich starts up an entire backend harness, complete with a number of mock\nservices. You can then provide overrides for services whose behavior you need to\nadjust for the test run. The function also accepts a number of ",(0,s.jsx)(t.em,{children:"features"})," (a\ncollective term for backend ",(0,s.jsx)(t.a,{href:"/docs/backend-system/architecture/plugins",children:"plugins"})," and\n",(0,s.jsx)(t.a,{href:"/docs/backend-system/architecture/modules",children:"modules"}),"), that are the subjects of the test."]}),"\n",(0,s.jsxs)(t.p,{children:["The function returns an HTTP server instance which can be used together with\ne.g. ",(0,s.jsx)(t.code,{children:"supertest"})," to easily test the actual REST service surfaces of plugins who\nregister routes with ",(0,s.jsx)(t.a,{href:"/docs/backend-system/core-services/index",children:"the HTTP router service API"}),"."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",children:"import { mockServices, startTestBackend } from '@backstage/backend-test-utils';\nimport request from 'supertest';\nimport { myPlugin } from './plugin.ts';\n\ndescribe('myPlugin', () => {\n  it('can serve values from config', async () => {\n    const fakeConfig = { myPlugin: { value: 7 } };\n\n    const { server } = await startTestBackend({\n      features: [\n        myPlugin(),\n        mockServices.rootConfig.factory({ data: fakeConfig }),\n      ],\n    });\n\n    const response = await request(server).get('/api/example/get-value');\n    expect(response.status).toBe(200);\n    expect(response.body).toEqual({ value: 7 });\n  });\n});\n"})}),"\n",(0,s.jsx)(t.p,{children:"This example shows how to access the mock service factories and\npass options to them, which will override the default mock services."}),"\n",(0,s.jsxs)(t.p,{children:["The returned server also has a ",(0,s.jsx)(t.code,{children:"port()"})," method which returns the dynamically\nbound listening port. You can use this to perform lower level network\ninteractions with the running test service."]}),"\n",(0,s.jsx)(t.h2,{id:"testing-remote-service-interactions",children:"Testing Remote Service Interactions"}),"\n",(0,s.jsxs)(t.p,{children:["If your backend plugin or service interacts with external services using HTTP\ncalls, we recommend leveraging the ",(0,s.jsx)(t.code,{children:"msw"})," package to intercept actual outgoing\nrequests and return mock responses. This lets you stub out remote services\nrather than the local clients, leading to more thorough and robust tests. You\ncan read more about how it works ",(0,s.jsx)(t.a,{href:"https://mswjs.io/",children:"in their documentation"}),"."]}),"\n",(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.code,{children:"@backstage/backend-test-utils"})," package exports a ",(0,s.jsx)(t.code,{children:"registerMswTestHooks"}),"\nfunction which ensures that the correct ",(0,s.jsx)(t.code,{children:"jest"})," lifecycle hooks are invoked to\nset up and tear down your ",(0,s.jsx)(t.code,{children:"msw"})," instance, and enables the option that completely\nrejects requests that don't match one of your mock rules. This ensures that your\ntests cannot accidentally leak traffic into production from tests."]}),"\n",(0,s.jsx)(t.p,{children:"Example:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",children:"import { registerMswTestHooks } from '@backstage/backend-test-utils';\nimport { rest } from 'msw';\nimport { setupServer } from 'msw/node';\n\ndescribe('read from remote', () => {\n  const worker = setupServer();\n  registerMswTestHooks(worker);\n\n  it('should auth and read successfully', async () => {\n    expect.assertions(1);\n\n    worker.use(\n      rest.get('https://remote-server.com/api/v3/foo', (req, res, ctx) => {\n        expect(req.headers.get('authorization')).toBe('Bearer fake');\n        return res(\n          ctx.status(200),\n          ctx.set('Content-Type', 'application/json'),\n          ctx.body(JSON.stringify({ value: 7 })),\n        );\n      }),\n    );\n\n    // exercise your plugin or service as usual, with real clients\n  });\n});\n"})}),"\n",(0,s.jsx)(t.h2,{id:"testing-database-interactions",children:"Testing Database Interactions"}),"\n",(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.code,{children:"@backstage/backend-test-utils"})," package includes facilities for testing your\nplugins' interactions with databases, including spinning up ",(0,s.jsx)(t.code,{children:"testcontainers"}),"\npowered Docker images with real database engines to connect to."]}),"\n",(0,s.jsx)(t.p,{children:"The base setup for such a test could look as follows:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",children:"// MyDatabaseClass.test.ts\nimport { TestDatabaseId, TestDatabases } from '@backstage/backend-test-utils';\nimport { MyDatabaseClass, type FooTableRow } from './MyDatabaseClass';\n\ndescribe('MyDatabaseClass', () => {\n  // Change this to the set of constants that you actually actively intend to\n  // support. This create call must be made inside a describe block. Make sure\n  // to create only one TestDatabases instance per file, since spinning up\n  // \"physical\" databases to test against is much costlier than creating the\n  // \"logical\" databases within them that the individual tests use.\n  const databases = TestDatabases.create({\n    ids: ['POSTGRES_16', 'POSTGRES_12', 'SQLITE_3', 'MYSQL_8'],\n  });\n\n  // Just an example of how to conveniently bundle up the setup code\n  async function createSubject(databaseId: TestDatabaseId) {\n    const knex = await databases.init(databaseId);\n    const subject = new MyDatabaseClass({ database: knex });\n    await subject.runMigrations();\n    return { knex, subject };\n  }\n\n  describe('foo', () => {\n    // Easily run the exact same test onto all supported databases\n    it.each(databases.eachSupportedId())(\n      'should run foo on %p',\n      async databaseId => {\n        const { knex, subject } = await createSubject(databaseId);\n        // raw knex is available for underlying manipulation\n        await knex<FooTableRow>('foo').insert({ value: 2 });\n        // drive your system under test as usual\n        await expect(subject.foos()).resolves.toEqual([{ value: 2 }]);\n      },\n    );\n  });\n});\n"})}),"\n",(0,s.jsxs)(t.p,{children:["If you want to pass the test database instance into backend plugins or services,\nyou can supply it in the form of a mock instance of ",(0,s.jsx)(t.code,{children:"coreServices.database"})," to\nyour test database."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",children:"const { knex, subject } = await createSubject(databaseId);\nconst { server } = await startTestBackend({\n  features: [\n    myPlugin(),\n    mockServices.database.mock({ getClient: async () => knex }),\n  ],\n});\n"})}),"\n",(0,s.jsxs)(t.p,{children:["When running locally, the tests only run against SQLite for the sake of speed.\nWhen the ",(0,s.jsx)(t.code,{children:"CI"})," environment variable is set, all given database engines are used."]}),"\n",(0,s.jsxs)(t.p,{children:["If you do not want or are unable to use docker based database engines, e.g. if\nyour CI environment is able to supply databases natively, the ",(0,s.jsx)(t.code,{children:"TestDatabases"}),"\nsupport custom connection strings through the use of environment variables that\nit'll take into account when present."]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.code,{children:"BACKSTAGE_TEST_DATABASE_POSTGRES13_CONNECTION_STRING"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.code,{children:"BACKSTAGE_TEST_DATABASE_POSTGRES9_CONNECTION_STRING"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.code,{children:"BACKSTAGE_TEST_DATABASE_MYSQL8_CONNECTION_STRING"})}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"testing-service-factories",children:"Testing Service Factories"}),"\n",(0,s.jsxs)(t.p,{children:["To facilitate testing of service factories, the ",(0,s.jsx)(t.code,{children:"@backstage/backend-test-utils"}),"\npackage provides a ",(0,s.jsx)(t.code,{children:"ServiceFactoryTester"})," helper that lets you instantiate services\nin a controlled context."]}),"\n",(0,s.jsxs)(t.p,{children:["The following example shows how to test a service factory where we also provide\na mocked implementation of the ",(0,s.jsx)(t.code,{children:"rootConfig"})," service."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",children:"import {\n  mockServices,\n  ServiceFactoryTester,\n} from '@backstage/backend-test-utils';\nimport { myServiceFactory } from './myServiceFactory.ts';\n\ndescribe('myServiceFactory', () => {\n  it('should provide value', async () => {\n    const fakeConfig = { myConfiguredValue: 7 };\n\n    const tester = ServiceFactoryTester.from(myServiceFactory, {\n      dependencies: [mockServices.rootConfig.factory({ data: fakeConfig })],\n    });\n\n    const myService = await tester.get('test-plugin');\n\n    expect(myService.getValue()).toBe(7);\n  });\n});\n"})}),"\n",(0,s.jsx)(t.p,{children:"The service factory tester also provides mocked implementations of the majority\nof all core services by default."})]})}function u(e={}){const{wrapper:t}={...(0,a.a)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},675251:(e,t,n)=>{var s=n(667294),a=Symbol.for("react.element"),i=Symbol.for("react.fragment"),r=Object.prototype.hasOwnProperty,o=s.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function d(e,t,n){var s,i={},d=null,l=null;for(s in void 0!==n&&(d=""+n),void 0!==t.key&&(d=""+t.key),void 0!==t.ref&&(l=t.ref),t)r.call(t,s)&&!c.hasOwnProperty(s)&&(i[s]=t[s]);if(e&&e.defaultProps)for(s in t=e.defaultProps)void 0===i[s]&&(i[s]=t[s]);return{$$typeof:a,type:e,key:d,ref:l,props:i,_owner:o.current}}t.Fragment=i,t.jsx=d,t.jsxs=d},785893:(e,t,n)=>{e.exports=n(675251)},511151:(e,t,n)=>{n.d(t,{Z:()=>o,a:()=>r});var s=n(667294);const a={},i=s.createContext(a);function r(e){const t=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),s.createElement(i.Provider,{value:t},e.children)}}}]);